<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peer-to-Peer Chat (Gun.js)</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Gun.js and SEA (Security, Encryption, Authorization) -->
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
    <style>
        /* Custom scrollbar for a better look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #64748b;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-slate-900 text-white antialiased">

    <!-- Main Application Container -->
    <div id="app-container" class="flex h-screen w-full opacity-0 transition-opacity duration-500">

        <!-- Left Panel: Online Users -->
        <div class="w-1/3 md:w-1/4 lg:w-1/5 bg-slate-800/50 p-4 flex flex-col border-r border-slate-700">
            <h2 class="text-xl font-bold mb-4 text-sky-400">Online Users</h2>
            <div class="flex-grow overflow-y-auto">
                <ul id="user-list" class="space-y-2">
                    <!-- User list will be populated by JavaScript -->
                    <li class="p-2 rounded-md bg-slate-700 animate-pulse">Connecting...</li>
                </ul>
            </div>
            <div class="mt-4 p-2 bg-slate-900 rounded-lg border border-slate-700">
                <p class="text-xs text-slate-400 mb-1">Your Unique ID:</p>
                <p id="your-id" class="text-xs font-mono break-all text-sky-300">Generating...</p>
            </div>
        </div>

        <!-- Right Panel: Chat Area -->
        <div class="w-2/3 md:w-3/4 lg:w-4/5 flex flex-col">
            <header class="p-4 bg-slate-800/50 border-b border-slate-700 shadow-md">
                <h1 class="text-xl font-bold">Public Chat Room</h1>
            </header>
            
            <!-- Messages Display -->
            <main id="chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4">
                <!-- Chat messages will be populated by JavaScript -->
            </main>

            <!-- Message Input Form -->
            <footer class="p-4 bg-slate-800/30">
                <form id="chat-form" class="flex items-center gap-4">
                    <input type="text" id="message-input" placeholder="Type your message..." autocomplete="off" class="flex-grow bg-slate-700 border border-slate-600 rounded-full py-3 px-5 focus:outline-none focus:ring-2 focus:ring-sky-500 transition-all">
                    <button type="submit" class="bg-sky-600 hover:bg-sky-500 text-white rounded-full p-3 transition-colors flex-shrink-0 shadow-lg hover:shadow-sky-500/50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                    </button>
                </form>
            </footer>
        </div>
    </div>

    <!-- Initial Loading / Welcome Modal -->
    <div id="welcome-modal" class="fixed inset-0 bg-slate-900 bg-opacity-80 backdrop-blur-sm flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl border border-slate-700 text-center">
            <h2 class="text-2xl font-bold text-sky-400 mb-4">P2P Chat</h2>
            <p id="modal-status" class="text-slate-300">Connecting to peer network...</p>
            <div class="mt-6 h-2 bg-slate-700 rounded-full overflow-hidden">
                <div class="h-2 bg-sky-500 animate-pulse w-full"></div>
            </div>
        </div>
    </div>

    <!-- Gun.js Application Logic -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Configuration and Initialization ---
            
            // Connect to Gun, using public relays to find peers
            const gun = Gun(['https://gun-manhattan.herokuapp.com/gun']);
            const user = gun.user();
            
            // --- DOM Element References ---
            const userListEl = document.getElementById('user-list');
            const chatMessagesEl = document.getElementById('chat-messages');
            const chatForm = document.getElementById('chat-form');
            const messageInput = document.getElementById('message-input');
            const yourIdElement = document.getElementById('your-id');
            const appContainer = document.getElementById('app-container');
            const welcomeModal = document.getElementById('welcome-modal');
            const modalStatus = document.getElementById('modal-status');

            // --- State Management ---
            let currentUserId = null;
            const onlineUsers = new Map();
            const messages = new Map();

            // --- Graph References ---
            const chatPath = 'p2p-chat-app/public-chat';
            const usersNode = gun.get(`${chatPath}/users`);
            const messagesNode = gun.get(`${chatPath}/messages`);

            // --- Core Functions ---

            /**
             * Renders the list of online users from the local state.
             */
            function renderUsers() {
                userListEl.innerHTML = ''; // Clear the list
                // Sort for consistent display order
                const sortedUsers = Array.from(onlineUsers.entries()).sort();

                sortedUsers.forEach(([id, userData]) => {
                    if (!userData) return; // Skip null/offline users
                    const li = document.createElement('li');
                    li.className = `p-2 rounded-md break-all text-sm font-mono ${id === currentUserId ? 'bg-sky-800/50 text-sky-300' : 'bg-slate-700 text-slate-300'}`;
                    li.textContent = id;
                    if (id === currentUserId) {
                        li.textContent += " (You)";
                    }
                    userListEl.appendChild(li);
                });
            }

            /**
             * Renders messages from the local state.
             */
            function renderMessages() {
                chatMessagesEl.innerHTML = ''; // Clear the display
                // Sort messages by timestamp
                const sortedMessages = Array.from(messages.values()).sort((a, b) => a.timestamp - b.timestamp);

                sortedMessages.forEach(msg => {
                    if(!msg || !msg.text || !msg.userId) return; // Skip invalid message objects

                    const isMyMessage = msg.userId === currentUserId;
                    const messageWrapper = document.createElement('div');
                    messageWrapper.className = `flex flex-col ${isMyMessage ? 'items-end' : 'items-start'}`;

                    const messageBubble = document.createElement('div');
                    messageBubble.className = `max-w-xs md:max-w-md lg:max-w-lg p-3 rounded-2xl shadow ${isMyMessage ? 'bg-sky-600 rounded-br-none' : 'bg-slate-700 rounded-bl-none'}`;
                    
                    const senderId = document.createElement('p');
                    senderId.className = 'text-xs font-mono break-all opacity-70 mb-1';
                    senderId.textContent = msg.userId;

                    const messageText = document.createElement('p');
                    messageText.className = 'text-white text-base';
                    messageText.textContent = msg.text;

                    messageBubble.appendChild(senderId);
                    messageBubble.appendChild(messageText);
                    messageWrapper.appendChild(messageBubble);
                    chatMessagesEl.appendChild(messageWrapper);
                });
                // Auto-scroll to the latest message
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            }

            // --- Gun.js Event Handlers ---
            
            /**
             * Listens for real-time updates to the 'users' graph node.
             */
            usersNode.map().on((userData, userId) => {
                if (userData) {
                    onlineUsers.set(userId, userData);
                } else {
                    onlineUsers.delete(userId);
                }
                renderUsers();
            });

            /**
             * Listens for new messages on the 'messages' graph node.
             */
            messagesNode.map().on((message, messageId) => {
                if(message) {
                    messages.set(messageId, message);
                } else {
                    messages.delete(messageId);
                }
                renderMessages();
            });

            // --- User Actions ---
            /**
             * Handles the chat form submission to send a new message.
             * @param {Event} e The form submission event.
             */
            function handleSendMessage(e) {
                e.preventDefault();
                const messageText = messageInput.value.trim();
                if (messageText && user.is) {
                    const message = {
                        userId: user.is.pub,
                        text: messageText,
                        timestamp: Gun.state()
                    };
                    // Set the message on the graph; .set() generates a unique ID for the object
                    messagesNode.set(message);
                    messageInput.value = ''; // Clear input field
                }
            }
            
            // --- App Initialization and User Creation ---
            
            // Create a new, temporary user on each load. No login/password needed.
            user.create(Gun.text.random(10), Gun.text.random(10), (ack) => {
                if (ack.err) {
                    modalStatus.textContent = `Error: ${ack.err}`;
                    return;
                }
                // Authentication successful
                user.auth(ack.sea);
                currentUserId = user.is.pub; // The user's public key is their ID
                yourIdElement.textContent = currentUserId;

                // Announce presence to other peers
                usersNode.get(currentUserId).put({ online: true });

                // Show the main app and hide the modal
                modalStatus.textContent = "Connected!";
                setTimeout(() => {
                    appContainer.classList.remove('opacity-0');
                    welcomeModal.classList.add('opacity-0');
                    setTimeout(() => welcomeModal.style.display = 'none', 300);
                }, 500);
            });


            // --- Event Listeners ---
            chatForm.addEventListener('submit', handleSendMessage);
            
            // Handle user leaving the page
            window.addEventListener('beforeunload', () => {
                if (user.is) {
                    // Signal to other peers that this user is gone.
                    // This is best-effort and might not always complete.
                    usersNode.get(user.is.pub).put(null);
                }
            });
        });
    </script>
</body>
</html>
